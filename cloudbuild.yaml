substitutions:
  _REGION: "us-central1"
  _IMAGE_NAME: "python-app"

steps:

# 1. Build Docker image
- name: "gcr.io/cloud-builders/docker"
  args:
    [
      "build",
      "-t",
      "us-central1-docker.pkg.dev/thematic-land-477215-a5/python-repo/${_IMAGE_NAME}:${SHORT_SHA}",
      "./app"
    ]

# 2. Push image
- name: "gcr.io/cloud-builders/docker"
  args:
    [
      "push",
      "us-central1-docker.pkg.dev/thematic-land-477215-a5/python-repo/${_IMAGE_NAME}:${SHORT_SHA}"
    ]

# 3. Update deployment.yaml
- name: "ubuntu"
  entrypoint: bash
  args:
    - "-c"
    - |
      sed -i "s|IMAGE_PLACEHOLDER|us-central1-docker.pkg.dev/thematic-land-477215-a5/python-repo/${_IMAGE_NAME}:${SHORT_SHA}|g" k8s/deployment.yaml

# 4. Commit and push
- name: "gcr.io/cloud-builders/git"
  entrypoint: bash
  args:
    - "-c"
    - |
      git config --global user.email "rachanack123@gmail.com"
      git config --global user.name "rachanack-rachhu"
      git add k8s/deployment.yaml
      git commit -m "Update image to ${SHORT_SHA}" || echo "No changes to commit"
      git push
